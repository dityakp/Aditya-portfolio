name: Create PR on Production Push

on:
  push:
    branches:
      - Production

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check if PR already exists
        id: check-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for existing open PR from Production to main
          PR_COUNT=$(gh pr list --base main --head Production --state open --json number --jq 'length')
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_count == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head Production \
            --title "ðŸš€ Deploy: Production â†’ Main" \
            --body "## Automated Deployment PR

          This Pull Request was automatically created when changes were pushed to the **Production** branch.
          
          ### ðŸ“‹ What's Changed
          Review the commits in this PR to see what's being deployed to the main branch.
          
          ### âœ… Pre-Merge Checklist
          - [ ] All tests passing
          - [ ] Code reviewed
          - [ ] No breaking changes
          - [ ] Documentation updated (if needed)
          
          ### ðŸ¤– Automation
          - **Source Branch:** Production
          - **Target Branch:** main
          - **Triggered by:** Push to Production
          
          ---
          _This PR was auto-generated by GitHub Actions_"
          
      - name: PR Already Exists
        if: steps.check-pr.outputs.pr_count != '0'
        run: |
          echo "âœ… A PR from Production to main already exists. Skipping PR creation."
          gh pr list --base main --head Production --state open
